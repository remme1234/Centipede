<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.example.releaseInfo.service.impl.ReleaseInfoMapper">
	
	<!-- 발매정보VO resultMap 설정 -->
	<resultMap id="releaseInfoList" type="egovframework.example.util.BoardVO">
	 	<result property="boardUid"		column="BOARD_UID"/>
	 	<result property="number"		column="NUMBER"/>
	 	<result property="title"		column="TITLE"/>
	 	<result property="contents"		column="CONTENTS"/>
	 	<result property="visitCnt"		column="VISIT_CNT"/>
	 	<result property="rsgstDt"		column="RSGST_DT"/>
	 	<result property="rsgstrId"		column="RSGSTR_ID"/>
	 	<result property="useYn"		column="USE_YN"/>
	 	<result property="fileNo"		column="FILE_NO"/>
	 	<result property="savedFileNm"	column="SAVED_FILE_NM"/>
	 	<result property="relDt"		column="REL_DT"/>
	</resultMap>
	
	<!-- 첨부파일정보VO resultMap 설정 -->
	<resultMap id="fileInfoList" type="egovframework.example.util.FileVO">
	 	<result property="fileNo"			column="FILE_NO"/>
	 	<result property="boardUid"			column="BOARD_UID"/>
	 	<result property="originFileNm"		column="ORIGIN_FILE_NM"/>
	 	<result property="savedFileNm"		column="SAVED_FILE_NM"/>
	 	<result property="savedFilePath"	column="SAVED_FILE_PATH"/>
	 	<result property="fileSize"			column="FILE_SIZE"/>
	 	<result property="rsgstrId"			column="RSGST_DT"/>
	 	<result property="useYn"			column="USE_YN"/>
	</resultMap>
	
	<!-- 발매정보게시판 목록 불러오기 -->
	<select id="selectReleaseInfoList" resultMap="releaseInfoList">
		SELECT A.*
		  FROM (
				SELECT BOARD_UID
					 , NUMBER
				     , TITLE
				     , CONTENTS
				     , RSGSTR_ID
				     , VISIT_CNT
					 , DATE_FORMAT(RSGST_DT, '%Y.%m.%d   %H:%i') AS RSGST_DT
					 , USE_YN
					 , REL_DT
					 , (SELECT SAVED_FILE_NM
						FROM   T_FILE
						WHERE  FILE_NO = TR.FILE_NO) AS SAVED_FILE_NM
				  FROM T_RELEASEINFO TR
				 WHERE USE_YN='Y' 
				) A 
		<if test="searchText != null and !searchText.equals('')">
			AND (TITLE LIKE CONCAT('%',#{searchText},'%') 
			 OR CONTENTS LIKE CONCAT('%',#{searchText},'%'))
		</if>
		ORDER BY RSGST_DT DESC LIMIT #{firstIndex},12
	</select>
	
	<!-- 페이징 처리를 위한 cnt  -->
	<select id="selectRelInfoViewListCnt" resultType="java.lang.Integer">
		SELECT  COUNT(1)
		FROM 	T_RELEASEINFO
		WHERE   USE_YN ='Y'  	  	 
	</select>
	
	
	<!-- 발매정보게시판 세부항목 불러오기 -->
	<select	id="selectReleaseInfoDetail" parameterType="egovframework.example.util.BoardVO" resultMap="releaseInfoList">
		SELECT BOARD_UID
			 , RSGSTR_ID
			 , NUMBER
			 , TITLE
			 , CONTENTS
			 , VISIT_CNT
			 , DATE_FORMAT(RSGST_DT, '%Y.%m.%d') AS RSGST_DT
			 , FILE_NO
		FROM   T_RELEASEINFO
		WHERE  NUMBER = #{number}
	</select>
	
	<!-- 세부항목에 첨부파일 정보 불러오기 -->
	<select id="selectFileList" parameterType="egovframework.example.util.BoardVO" resultMap="fileInfoList">
		SELECT 	FILE_NO
			   ,ORIGIN_FILE_NM
			   ,SAVED_FILE_NM
			   ,SAVED_FILE_PATH
			   ,ROUND(FILE_SIZE/1024,1) AS FILE_SIZE
		FROM   	T_FILE 
		WHERE  	FILE_NO =  #{fileNo}
		AND     USE_YN = 'Y'
	</select>
	
	<!-- 발매정보게시판 작성 및 수정시 DB에 추가 하는 쿼리 -->
	<update id="updateReleaseInfo" parameterType="egovframework.example.util.BoardVO">
		INSERT INTO T_RELEASEINFO (BOARD_UID, NUMBER, TITLE, CONTENTS, REL_DT,RSGSTR_ID, VISIT_CNT, RSGST_DT, FILE_NO, USE_YN)
		VALUES 		(#{boardUid}
		<if test='number == null or "".equals(number)'>
			, (SELECT IFNULL(MAX(NUMBER),0)+1 FROM T_RELEASEINFO AS TC)
		</if>
		<if test='number != null and !"".equals(number)'>
			,#{number}
		</if>
		, #{title}, #{contents},#{relDt}, "SAMPLE", "0", now()
		<if test='fileNo == null or "".equals(fileNo)'>
			,(SELECT IFNULL(MAX(FILE_NO),0)+1 FROM T_FILE AS TR)
		</if>
		<if test='fileNo != null and !"".equals(fileNo)'>
			,#{fileNo}
		</if>
		,"Y")
		ON DUPLICATE KEY 
		UPDATE TITLE 	= #{title},
			   CONTENTS = #{contents}
	</update>	
	
	<!-- 발매정보게시판 삭제시 논리적 삭제 쿼리 -->  
	<update id="deleteReleaseInfoDelete">
		UPDATE T_RELEASEINFO
		SET USE_YN = 'N'
		WHERE NUMBER = #{number}
	</update>
	
	<!-- 조회수 증가 쿼리 -->
	<update id="addVisitCnt"> 
		UPDATE T_RELEASEINFO
		SET VISIT_CNT = VISIT_CNT +1
		WHERE NUMBER = #{number}
	</update>
	
	<!-- 첨부파일저장 -->
	<insert id="insertFile" parameterType="egovframework.example.util.FileVO">
        INSERT INTO T_FILE
        (
            FILE_NO,
            BOARD_UID,
            ORIGIN_FILE_NM,
            SAVED_FILE_NM,
            SAVED_FILE_PATH,
            FILE_SIZE,
            RSGST_DT,
            RSGSTR_ID
        )
        VALUES
        (	
	        <if test='fileNo == null or "".equals(fileNo)'>
				(SELECT IFNULL(MAX(FILE_NO),0)+1 FROM T_FILE AS TF)
			</if>
			<if test='fileNo != null and !"".equals(fileNo)'>
				,#{fileNo}
			</if>
            ,#{boardUid}
            ,#{originFileNm}
            ,#{savedFileNm}
            ,#{savedFilePath}
            ,#{fileSize}
            ,NOW()
            ,'SAMPLE'
        )
	</insert>
</mapper>